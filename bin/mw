#!/bin/bash

set -a

prefix="/usr/local"
maildir="${XDG_DATA_HOME:-$HOME/.local/share}/mail"
muttshare="$prefix/share/mutt-wizard"
cachedir="${XDG_CACHE_HOME:-$HOME/.cache}/mutt-wizard"
muttrc="${XDG_CONFIG_HOME:-$HOME/.config}/mutt/muttrc"
accdir="${XDG_CONFIG_HOME:-$HOME/.config}/mutt/accounts"
msmtprc="${XDG_CONFIG_HOME:-$HOME/.config}/msmtp/config"
msmtplog="${XDG_STATE_HOME:-$HOME/.local/state}/msmtp/msmtp.log"
mbsyncrc="${MBSYNCRC:-$HOME/.mbsyncrc}"
mpoprc="${XDG_CONFIG_HOME:-$HOME/.config}/mpop/config"
imapnotify="${XDG_CONFIG_HOME:-$HOME/.config}/imapnotify"
mpoptemp="$muttshare/mpop-temp"
mbsynctemp="$muttshare/mbsync-temp"
mutttemp="$muttshare/mutt-temp"
msmtptemp="$muttshare/msmtp-temp"
onlinetemp="$muttshare/online-temp"
notmuchtemp="$muttshare/notmuch-temp"
imapnotifytemp="$muttshare/imapnotify-temp"
# Durch die Verwendung von Templates ist Parameter-Substitution unmöglich.
# Daher werden hier einige Standard-Variablen gesetzt, die andernfalls
# überschrieben werden könnten.
iport="993"
sport="465"
imapssl="IMAPS"
tlsline="tls_starttls off"
maxmes="0"

alias mbsync='mbsync -c "$mbsyncrc"'

# mbsync >=1.4.0 benötigt "Far/Near" anstatt "Master/Slave."
mbver="$(mbsync -v)"
mbver="${mbver#* }"
mbver="${mbver%.*}"
# Der Vergleich zweier Fließkommazahlen in Bash ist umständlich, daher
# entfernen wir die Punkte und machen daraus schöne Ganzzahlen
mbver="${mbver/\./}"
if [ "${mbver}" -gt 14 ]; then
	master="Far"
	slave="Near"
else
	master="Master"
	slave="Slave"
fi

for x in "/etc/ssl/certs/ca-certificates.crt" \
	"/etc/pki/tls/certs/ca-bundle.crt" "/etc/ssl/cert.pem" \
	"/etc/ssl/ca-bundle.pem" "/etc/pki/tls/cacert.pem" \
	"/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem" \
	"/usr/local/share/ca-certificates/"; do
	[ -f "$x" ] && sslcert="$x" && break
done || { echo "CA-Zertifikat nicht gefunden. Bitte installieren Sie eins oder verlinken Sie es nach /etc/ssl/certs/ca-certificates.crt" && exit 1; }

checkbasics() {
	command -V gpg >/dev/null 2>&1 && GPG="gpg" || GPG="gpg2"
	PASSWORD_STORE_DIR="${PASSWORD_STORE_DIR:-$HOME/.password-store}"
	[ -r "$PASSWORD_STORE_DIR/.gpg-id" ] || {
		echo "Führen Sie zuerst \`pass init <ihre-gpg-email>\` aus, um ein Passwort-Archiv einzurichten."
		echo "(Falls Sie noch kein GPG-Schlüsselpaar haben, führen Sie zuerst \`$GPG --full-generate-key\` aus.)"
		exit 1
	}
}

getaccounts() { accounts="$(find -L "$accdir" -type f 2>/dev/null | grep -o "\S*.muttrc" | sed "s|.*/\([0-9]-\)*||;s/\.muttrc$//" | nl)"; }

list() { getaccounts && [ -n "$accounts" ] && echo "$accounts" || exit 1; }

prepmsmtp() {
	mkdir -p "${msmtprc%/*}" "${msmtplog%/*}"
	ln -s "$msmtprc" "$HOME/.msmtprc" 2>/dev/null
	envsubst <"$msmtptemp" >>"$msmtprc"
}

prepmbsync() {
	mkdir -p "${mbsyncrc%/*}"
	[ -f "$mbsyncrc" ] && echo >>"$mbsyncrc"
	envsubst <"$mbsynctemp" >>"$mbsyncrc"
}

prepmpop() {
	mkdir -p "${mpoprc%/*}"
	envsubst <"$mpoptemp" >>"$mpoprc"
}

prepimapnotify() {
  mkdir -p "$imapnotify" ; envsubst < "$imapnotifytemp" >> "$imapnotify/$fulladdr.conf"
}

prepmutt() {
	mkdir -p "${muttrc%/*}" "$accdir"
	envsubst <"$mutttemp" >"$accdir/$fulladdr.muttrc"
	[ ! -f "$muttrc" ] && echo "# vim: filetype=neomuttrc" >"$muttrc"
	! grep -q "^source.*mutt-wizard.muttrc" "$muttrc" && echo "source $muttshare/mutt-wizard.muttrc" >>"$muttrc"
	! grep "^source.*.muttrc" "$muttrc" | grep -qv "$muttshare/mutt-wizard.muttrc" && echo "source $accdir/$fulladdr.muttrc" >>"$muttrc"
	echo "macro index,pager i$idnum '<sync-mailbox><enter-command>source $accdir/$fulladdr.muttrc<enter><change-folder>!<enter>;<check-stats>' \"zu $fulladdr wechseln\"" >>"$muttrc"
	neomutt -v | grep -q lmdb && ! grep -q "^set header_cache_backend.*lmdb" "$muttrc" && echo "set header_cache_backend = \"lmdb\"" >>"$muttrc"
}

getprofiles() {
	safename="$(echo $fulladdr | sed 's/@/_/g')"
	case "$type" in
	online)
		folder="imaps://$login@$imap:$iport"
		extra="$(envsubst <"$onlinetemp")"
		;;
	pop) prepmpop ;;
	*)
		case "$iport" in
		1143) imapssl=None ;;
		143) imapssl=STARTTLS ;;
		esac
		prepmbsync
		;;
	esac
	prepmsmtp
	prepmutt
	prepnotmuch
  prepimapnotify
}

parsedomains() {
	serverinfo="$(grep "^${fulladdr#*@}" "$muttshare/domains.csv" 2>/dev/null)"

	[ -z "$serverinfo" ] && serverinfo="$(grep "$(echo "${fulladdr#*@}" | sed "s/\.[^\.]*$/\.\\\*/")" "$muttshare/domains.csv" 2>/dev/null)"

	IFS=, read -r service imapsugg iportsugg smtpsugg sportsugg <<EOF
$serverinfo
EOF
	imap="${imap:-$imapsugg}"
	smtp="${smtp:-$smtpsugg}"
	sport="${sport:-$sportsugg}"
	iport="${iport:-$iportsugg}"
}

delete() {
	if [ -z "${fulladdr+x}" ]; then
		echo "Wählen Sie das Konto aus, das Sie löschen möchten (nach Nummer):"
		list || exit 1
		read -r input
		match="^\s*$input\s\+"
	else
		match="\s\+$fulladdr$"
		getaccounts
	fi

	fulladdr="$(echo "$accounts" | grep "$match" | grep -o "\S*@\S*")"

	[ -z "$fulladdr" ] && echo "$fulladdr ist kein gültiger Kontoname." && return 1

	sed -ibu "/IMAPStore $fulladdr-remote$/,/# End profile/d" "$mbsyncrc" 2>/dev/null
	rm -f "$mbsyncrc"bu
	rm -rf "${cachedir:?}/${fulladdr:?}" "$accdir/$fulladdr.muttrc" "$accdir/"[0-9]-"$fulladdr.muttrc"
	sed -ibu "/\([0-9]-\)\?$fulladdr.muttrc/d" "$muttrc" 2>/dev/null
	rm -f "$muttrc"bu
	sed -ibu "/account $fulladdr$/,/^\(\s*$\|account\)/d" "$msmtprc" 2>/dev/null
	rm -f "$msmtprc"bu
	sed -ibu "/account $fulladdr$/,/^\(\s*$\|account\)/d" "$mpoprc" 2>/dev/null
	rm -f "$mpoprc"bu
	pass rm -f "$passprefix$fulladdr" >/dev/null 2>&1
	[ -n "${purge+x}" ] && safename="$(echo $fulladdr | sed 's/@/_/g')" && rm -rf "${cachedir:?}/${safename:?}" "${maildir:?}/${fulladdr:?}"
}

askinfo() {
	[ -z "$fulladdr" ] && echo "Geben Sie die vollständige E-Mail-Adresse ein, die hinzugefügt werden soll:" &&
		read -r fulladdr
	while ! echo "$fulladdr" | grep -qE "^.+@.+\.[A-Za-z]+$"; do
		echo "$fulladdr ist keine gültige E-Mail-Adresse. Bitte geben Sie die Adresse erneut ein:"
		read -r fulladdr
	done
	folder="$maildir/$fulladdr"
	getaccounts
	echo "$accounts" | grep -q "\s$fulladdr$" 2>/dev/null &&
		{ echo "$fulladdr wurde bereits hinzugefügt" && exit 1; }
	{ [ -z "$imap" ] || [ -z "$smtp" ]; } && parsedomains
	[ -z "$imap" ] && echo "Geben Sie die IMAP-Adresse Ihres E-Mail-Servers ein (ohne Portnummer):" &&
		read -r imap
	[ -z "$smtp" ] && echo "Geben Sie die SMTP-Adresse Ihres E-Mail-Servers ein (ohne Portnummer):" &&
		read -r smtp
	case $sport in
	587) tlsline="# tls_starttls" ;;
	esac
	[ -z "$realname" ] && realname="${fulladdr%%@*}"
	[ -z "$passprefix" ] && passprefix=""
	hostname="${fulladdr#*@}"
	login="${login:-$fulladdr}"
	if [ -n "${password+x}" ] && [ ! -f "$PASSWORD_STORE_DIR/$passprefix$fulladdr.gpg" ]; then
		insertpass
	elif [ ! -f "$PASSWORD_STORE_DIR/$passprefix$fulladdr.gpg" ]; then
		getpass
    fi
}

insertpass() {
	printf "%s" "$password" | pass insert -fe "$passprefix$fulladdr"
}

errorexit() {
	echo "Anmeldung nicht erfolgreich."
	case "$imap" in
	imap.gmail.com)
		echo "Dieses Konto mit $service verwendet Googles Gmail-Server, die alle Drittanbieter-Anwendungen ohne ein anwendungsspezifisches Passwort deaktivieren.
Stellen Sie sicher, dass Sie OAUTH mit Ihrem Gmail-Konto verwenden, oder noch besser: Hören Sie auf, Gmail zu nutzen."
		;;
	imap.mail.me.com)
		echo "Dieses Konto mit $service verwendet Apples iCloud-Server, die standardmäßig alle Nicht-Apple-Anwendungen deaktivieren.
Stellen Sie sicher, dass Sie entweder Drittanbieter-Anwendungen aktivieren oder ein App-spezifisches Passwort erstellen, oder am besten: Hören Sie auf, Apple zu nutzen."
		;;
	esac
	exit 1
}

getpass() { while :; do
	pass rm -f "$passprefix$fulladdr" >/dev/null 2>&1
	pass insert -f "$passprefix$fulladdr" && break
done; }

getboxes() {
	if [ -n "${force+x}" ]; then
		mailboxes="$(printf "INBOX\\nDrafts\\nJunk\\nTrash\\nSent\\nArchive")"
	else
		info="$(curl --location-trusted -s -m 5 --user "$login:$(pass "$passprefix$fulladdr")" --url "${protocol:-imaps}://$imap:${iport:-993}")"
		[ -z "$info" ] && errorexit
		mailboxes="$(echo "$info" | grep -v HasChildren | sed "s/.*\" //;s/\"//g" | tr -d '\r')"
	fi
	[ "$type" = "pop" ] && mailboxes="INBOX"
	for x in $(
		sed -n "/^macro.* i[0-9] / s/\(^macro.* i\| .*\)//gp " "$muttrc" 2>/dev/null | sort -u
		echo 0
	); do
		idnum=$((idnum + 1))
		[ "$idnum" -eq "$x" ] || break
	done
	toappend="mailboxes $(echo "$mailboxes" | sed "s/^/\"=/;s/$/\"/;s/'/\\\'/g" | paste -sd ' ' -)"
}

finalize() {
	echo "$toappend" >>"$accdir/$fulladdr.muttrc"
	[ "$type" != "online" ] && echo "$mailboxes" | xargs -I {} mkdir -p "$maildir/$fulladdr/{}/cur" "$maildir/$fulladdr/{}/tmp" "$maildir/$fulladdr/{}/new"
	mkdir -p "$cachedir/$safename/bodies"
	echo "$fulladdr (Konto #$idnum) erfolgreich hinzugefügt."
	command -V urlview >/dev/null 2>&1 && [ ! -f "$HOME/.urlview" ] && echo "COMMAND \$BROWSER" >"$HOME/.urlview"
	return 0
}

prepnotmuch() {
	[ -z "$NOTMUCH_CONFIG" ] && NOTMUCH_CONFIG="$HOME/.notmuch-config"
	[ -f "$NOTMUCH_CONFIG" ] && return 0
	envsubst <"$notmuchtemp" >"$NOTMUCH_CONFIG"
}

togglecron() {
	cron="$(mktemp)"
	crontab -l >"$cron"
	if grep -q mailsync "$cron"; then
		echo "Entferne automatische Mailsynchronisation..."
		sed -ibu /mailsync/d "$cron"
		rm -f "$cron"bu
	else
		echo "Füge automatische Mailsynchronisation alle ${cronmin:-10} Minuten hinzu..."
		echo "*/${cronmin:-10} * * * * $prefix/bin/mailsync" >>"$cron"
	fi &&
		crontab "$cron"
	rm -f "$cron"
}

setact() { if [ -n "${action+x}" ] && [ "$action" != "$1" ]; then
	echo "Führe $1 mit $action aus..."
	echo "Inkompatible Optionen angegeben. Pro Ausführung kann nur eine Aktion angegeben werden."
	exit 1
else
	action="$1"
fi; }

mwinfo() {
	cat <<EOF
mw: mutt-wizard - E-Mail-Konten automatisch für mutt konfigurieren,
    einschließlich herunterladbarer E-Mails mit \`mbsync\`.

Hauptaktionen:
  -a ihre@email.com	E-Mail-Adresse hinzufügen
  -l			Konfigurierte E-Mail-Adressen auflisten
  -d			Bereits hinzugefügte Adresse entfernen
  -D ihre@email.com	Konto ohne Bestätigung erzwungen entfernen
  -t Zahl		Automatische Mailsynchronisation alle <Zahl> Minuten umschalten
  -T			Automatische Mailsynchronisation umschalten
  -r			Kontonummern neu ordnen

Optionen, die mit -a erlaubt sind:
  -u	Konto-Login-Name, falls nicht die vollständige Adresse
  -n	"Echter Name" für das E-Mail-Konto
  -i	IMAP/POP-Serveradresse
  -I	IMAP/POP-Server-Port
  -s	SMTP-Serveradresse
  -S	SMTP-Server-Port
  -x	Passwort für das Konto (empfohlen in doppelten Anführungszeichen)
  -p	Für einen POP-Server statt IMAP hinzufügen
  -P	Pass-Präfix (Präfix der Datei, in der das Passwort gespeichert wird)
  -X	Auch lokale E-Mails eines Kontos beim Löschen entfernen
  -o	Adresse konfigurieren, aber E-Mails online behalten
  -f	Typische englische Mailboxen annehmen, ohne Login-Versuch

HINWEIS: Sobald mindestens ein Konto hinzugefügt wurde, können Sie
\`mbsync -a\` ausführen, um den E-Mail-Download zu starten.

Um das Passwort eines Kontos zu ändern, führen Sie \`pass edit '$passprefix'ihre@email.com\` aus.
EOF
}

reorder() {
	tempfile="$(mktemp -u)"
	trap 'rm -f $tempfile' HUP INT QUIT TERM PWR EXIT
	echo "# Ordnen Sie diese Konten vorsichtig mit den gewünschten Nummern in der ersten Spalte neu.
# Ordnen Sie NICHT die Zeilen neu oder benennen Sie die Konten in der zweiten Spalte um." >"$tempfile"
	sed -n "
	/ i[0-9] / s?\(.* i\|'<sync.*/\|\.muttrc.*\)??g p
	" "$muttrc" >>"$tempfile"
	${EDITOR:-vim} "$tempfile" || exit 1
	sed -i -e 's/#.*//' -e '/^$/d' "$tempfile"
	default="$(sort -n "$tempfile" | head -n 1)"
	default="${default#* }"
	sed -ibu "
  /.* i[0-9] .*.muttrc/d
  /^source.*accounts.*.muttrc/d
  " "$muttrc" 2>/dev/null
	rm -f "$muttrc"bu
	awk -v a="$accdir" -v d="$default" ' BEGIN { print "source "a"/"d".muttrc" }
		{
		print "macro index,pager i"$1" '\''<sync-mailbox><enter-command>source "a"/"$2".muttrc<enter><change-folder>!<enter>;<check-stats>'\'' \"zu "$2" wechseln\""
		}
	' "$tempfile" >>"$muttrc"
}

while getopts "rfpXlhodTYD:y:i:I:s:S:u:a:n:P:x:m:t:" o; do case "${o}" in
	l) setact list ;;
	r) setact reorder ;;
	d) setact delete ;;
	D)
		setact delete
		fulladdr="$OPTARG"
		;;
	y)
		setact sync
		fulladdr="$OPTARG"
		;;
	Y) setact sync ;;
	a)
		setact add
		fulladdr="$OPTARG"
		;;
	i)
		setact add
		imap="$OPTARG"
		;;
	I)
		setact add
		iport="$OPTARG"
		;;
	s)
		setact add
		smtp="$OPTARG"
		;;
	S)
		setact add
		sport="$OPTARG"
		;;
	u)
		setact add
		login="$OPTARG"
		;;
	n)
		setact add
		realname="$OPTARG"
		;;
	P)
		setact add
		passprefix="$OPTARG"
		;;
	m)
		setact add
		maxmes="$OPTARG"
		;;
	o)
		setact add
		type="online"
		;;
	p)
		setact add
		type="pop"
		protocol="pop3s"
		iport="${iport:-995}"
		;;
	f)
		setact add
		force=True
		;;
	x)
		setact add
		password="$OPTARG"
		;;
	X)
		setact delete
		purge=True
		;;
	t)
		setact toggle
		cronmin="$OPTARG"
		;;
	T) setact toggle ;;
	h) setact info ;;
	\?)
		echo "Siehe \`$(basename $0) -h\` für mögliche Optionen und Hilfe."
		exit 1
		;;
	esac done

[ -z "$action" ] && action="info"

case "$action" in
list) list ;;
add) checkbasics && askinfo && getboxes && getprofiles && finalize ;;
delete) delete ;;
sync)
	echo "\`mw -y\` und \`mw -Y\` sind jetzt veraltet und werden in einem zukünftigen Update entfernt. Bitte wechseln Sie zur Verwendung von \`mailsync\`."
	mailsync $fulladdr
	;;
toggle) togglecron ;;
reorder) reorder ;;
info)
	mwinfo
	exit 1
	;;
esac
